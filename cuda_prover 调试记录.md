## cuda_prover 调试记录

2020.10.21

---

#### 任务目标

存在两个版本，cuda_prover.cu和cuda_prover_use_origin_compute_H.cu，两个版本结果不一样

#### origin版本中间输出数据

```
B::print_G1(final_C);
38504971800158054166900748170642295741174235479281135652527869406407740101411095600466786133055190871190655177697827195847374833008710953846021934682114031578634773155616714950649636028153617688407408178016680029136214759403412 , 28412757620928747343810280137403341723849087815665183163218835063875425698714552422588790635552291686603665387391623753486886819210937831343481863693250790316264275192991583902394036536639486003397829016307792037851201839185453

B::print_G1(evaluation_At);
40361528851292339345855812165086023382323309718513897622902874122483346627973823933464805637565865005519760505478660019167147270387235855164579731801369647130593112655809325208937217816514099017172308180483589350860289746831709 , 23376759081023118478934187648426084480884676539683659226556750963110664339992299982299997764330628577226757470124418598730029542469546657826296266457249453427184831984170844166217062228595162154011275968811438926459934984097266

B::print_G1(evaluation_Ht);
16794788859808581176658059244467291505659644651049363244108450086633597740304427320236581912246381621730659150691979255922017108196069599502605874975187717324176650582492597325991890517901837694333369249966315321840064422490272 , 36698278860389901099570848945347827846188657627708562786283858057399538220679766688290037987769440989280254870429901370117763013589172190930597801471885323555419347183262029585554829366680681882970059571476419302226324179882245

B::print_G2(evaluation_Bt2);
20633591288442611055228323886840050645309586168049397935954500868371997219211569299745299267104253355263102480635799878375500472267374123275479668810489026293549843149264817282407606837386145511899910776074607233248963923479273*z + 40053918384646691842847970370937813278337652690081961841928666226179487940670550301400319089377785889517246630109962768982416768051268983432597437743990505657076804170686198005235676637384143877416443969397834729604449625043117 , 22072563624648787028939592745406670603523193268931735151424386766237218279451036780431291384050966541462866257292644106474819310081901205945285169627259849286352740564212617865264837964500225957402534604649239549002572085922439*z + 10247943272157134609959216175035829187653221370541692859566861487897973160733141235086232673191806193454100562431011885020498431747786426107942633293194019588083290311511451241076266982251960149479014629612701364540065782624311
```

#### 动作1

将cuda_prover_use_origin_compute_H中的这两行替换一下

```
//G1 *evaluation_At = B::multiexp_G1(B::input_w(inputs), B::params_A(params), m + 1);
ec_reduce_straus<ECp, C, R>(sA, out_A.get(), A_mults.get(), w, m + 1);
```

读入的文件改为preprocessed.18.dat.all（结果和origin一样），方便两边结果对比

#### 动作2

将cuda_prover中的这些代码注释掉，换成CPU端的compute_H、multiexp_G1，evaluation_Ht恢复正确

```
    // auto H_mults = load_points_affine<ECp_MNT4>(
    //     ((1U << C) - 1) * (d), preprocessed_file);
    
    // auto coefficients_for_H = compute_H(sH, sH_H2M, inputs);
    
    // cudaStreamSynchronize(sH);
    // auto out_H = ECp_MNT4_ec_reduce_pippenger(sH, H_mults.get(), coefficients_for_H, d);
    
    // cudaStreamSynchronize(sH);
    // G1 *evaluation_Ht = B::read_pt_ECp(out_H.get());
```

#### 动作3

将cuda_prover中的 evaluation_Ht 用 cudaMallocHost分配，便于debug和双版本对比

接下来增加print_Fr方法，使coefficients_for_H支持查看结果，在n=18的情况下，coefficients_for_H变量内容和18_cpu_result.log结果对应

    void mnt4753_libsnark::print_Fr(mnt4753_libsnark::vector_Fr *scalar_start, size_t i) {
     std::vector<Fr<mnt4753_pp>> &P = *scalar_start->data;
     for(int j = 0 ; j < i ; j++){
      for (int k = 0; k < 12; ++k) {
        auto H = P[j].mont_repr.data;
        printf("%lu%c", H[k], " \n"[k + 1 == 12]);
      }
     }
    }
